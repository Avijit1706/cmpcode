<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TCS SSC Marketplace Preview</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
:root {
  font-family: Inter, system-ui, sans-serif;
  color-scheme: light;
}

* { box-sizing: border-box; }
body { margin: 0; background: #f3f8ff; color: #0f172a; }
[data-theme='dark'] body { background: #0b1220; color: #e2e8f0; }

.app-shell { min-height: 100vh; display: flex; }
.sidebar {
  width: 260px;
  background: linear-gradient(180deg, #0a1735, #081127);
  color: #dbeafe;
  padding: 1rem;
  border-right: 1px solid rgba(59, 130, 246, 0.25);
  position: sticky;
  top: 0;
  height: 100vh;
}
[data-theme='light'] .sidebar {
  background: linear-gradient(180deg, #dbeafe, #eff6ff);
  color: #1e3a8a;
  border-right: 1px solid #bfdbfe;
}
.sidebar-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.sidebar-head p { margin: 0; font-size: 0.72rem; letter-spacing: 0.13em; }
.sidebar-head h2 { margin: 0.2rem 0 0; font-size: 1.1rem; }
.nav-item {
  width: 100%;
  text-align: left;
  border: 0;
  background: transparent;
  color: inherit;
  padding: 0.62rem 0.75rem;
  border-radius: 0.7rem;
  text-transform: capitalize;
  cursor: pointer;
  transition: 0.2s ease;
}
.nav-item:hover, .nav-item.active { background: rgba(59, 130, 246, 0.24); }

.content {
  flex: 1;
  padding: 1.3rem;
  background: radial-gradient(circle at 0% 0%, rgba(37, 99, 235, 0.14), transparent 42%);
}
.topbar { display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 1rem; }
.topbar-left { display: flex; align-items: center; gap: 0.7rem; }
.topbar h1 { margin: 0; font-size: 1.45rem; }
.topbar p { margin: 0.2rem 0 0; color: #64748b; }
[data-theme='dark'] .topbar p { color: #93c5fd; }
.topbar-right { display: flex; gap: 0.6rem; }

.btn {
  border-radius: 0.65rem;
  border: 1px solid transparent;
  padding: 0.48rem 0.8rem;
  font-weight: 600;
  cursor: pointer;
}
.btn.primary {
  background: linear-gradient(120deg, #2563eb, #1d4ed8);
  color: white;
  box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
}
.btn.muted { background: transparent; border-color: rgba(100, 116, 139, 0.45); color: inherit; }

.view-stack { display: grid; gap: 1rem; }
.card-strip,
.mini-kpi-grid {
  display: grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  gap: 0.7rem;
}

.mini-card {
  border-radius: 0.85rem;
  border: 1px solid #bfdbfe;
  background: linear-gradient(150deg, rgba(255, 255, 255, 0.96), rgba(219, 234, 254, 0.88));
  padding: 0.75rem;
  min-height: 94px;
}
[data-theme='dark'] .mini-card {
  border-color: rgba(96, 165, 250, 0.34);
  background: linear-gradient(150deg, rgba(11, 25, 52, 0.9), rgba(15, 23, 42, 0.88));
}
.mini-card p { margin: 0; font-size: 0.72rem; letter-spacing: 0.04em; text-transform: uppercase; color: #64748b; }
.mini-card h4 { margin: 0.4rem 0 0.2rem; font-size: 1.25rem; color: #1d4ed8; }
.mini-card small { color: #64748b; font-size: 0.72rem; }

.panel,
.catalog-card,
.catalog-chip {
  border-radius: 1rem;
  border: 1px solid #bfdbfe;
  background: rgba(255, 255, 255, 0.95);
  box-shadow: 0 10px 28px rgba(15, 23, 42, 0.08);
}
[data-theme='dark'] .panel,
[data-theme='dark'] .catalog-card,
[data-theme='dark'] .catalog-chip {
  border-color: rgba(96, 165, 250, 0.3);
  background: linear-gradient(160deg, rgba(17, 28, 52, 0.92), rgba(13, 22, 43, 0.9));
}
.panel { padding: 1rem; }
.panel.compact { padding: 0.8rem; }
.panel-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
.panel h3 { margin: 0 0 0.45rem; }

.quick-links { display: flex; flex-wrap: wrap; gap: 0.6rem; }
.quick-links a {
  text-decoration: none;
  color: #1d4ed8;
  font-weight: 600;
  border: 1px solid #bfdbfe;
  border-radius: 999px;
  padding: 0.36rem 0.72rem;
  background: #eff6ff;
}
[data-theme='dark'] .quick-links a { background: rgba(30, 58, 138, 0.25); border-color: rgba(96, 165, 250, 0.34); color: #93c5fd; }

.catalog-grid { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 0.7rem; }
.catalog-grid.small { grid-template-columns: repeat(3, minmax(0, 1fr)); }
.catalog-card { padding: 0.8rem; }
.catalog-card h4 { margin: 0; color: #1d4ed8; font-size: 0.98rem; }
.catalog-card p { margin: 0.35rem 0; font-size: 0.82rem; color: #64748b; min-height: 38px; }
.catalog-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 0.45rem; }
.catalog-footer span { font-size: 0.72rem; color: #64748b; }

.catalog-chip {
  padding: 0.75rem;
  display: grid;
  gap: 0.28rem;
}
.catalog-chip strong { font-size: 0.9rem; }
.catalog-chip span { font-size: 0.76rem; color: #64748b; }
.catalog-chip a { font-size: 0.78rem; color: #2563eb; text-decoration: none; font-weight: 600; }

.dialog-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.65rem; }
.dialog-grid label { display: grid; gap: 0.25rem; font-size: 0.85rem; }
.dialog-grid input,
.dialog-grid select,
.dialog-grid textarea {
  border: 1px solid #bfdbfe;
  border-radius: 0.6rem;
  padding: 0.43rem;
  background: transparent;
  color: inherit;
}

.grid.two-col { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.8rem; }
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
th,
td { text-align: left; padding: 0.45rem; border-bottom: 1px solid rgba(148, 163, 184, 0.3); font-size: 0.82rem; }

.profile-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.7rem; }
.profile-grid div { border: 1px solid #bfdbfe; border-radius: 0.7rem; padding: 0.62rem; }
[data-theme='dark'] .profile-grid div { border-color: rgba(96, 165, 250, 0.28); }
.profile-grid span { font-size: 0.72rem; color: #64748b; display: block; }

.mobile-only { display: none; }

@media (max-width: 1280px) {
  .card-strip,
  .mini-kpi-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
  .catalog-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
}

@media (max-width: 1024px) {
  .sidebar { position: fixed; left: 0; transform: translateX(-100%); z-index: 20; }
  .sidebar.open { transform: translateX(0); }
  .mobile-only { display: inline-flex; }
  .card-strip,
  .mini-kpi-grid,
  .catalog-grid,
  .catalog-grid.small,
  .grid.two-col,
  .dialog-grid,
  .profile-grid { grid-template-columns: 1fr; }
}

.status-badge {
  display: inline-flex;
  align-items: center;
  border-radius: 999px;
  padding: 0.15rem 0.5rem;
  font-size: 0.72rem;
  font-weight: 700;
  text-transform: capitalize;
}
.status-badge.active { background: rgba(22, 163, 74, 0.18); color: #16a34a; }
.status-badge.warning { background: rgba(245, 158, 11, 0.2); color: #d97706; }
.status-badge.retired { background: rgba(148, 163, 184, 0.25); color: #475569; }
[data-theme="dark"] .status-badge.active { background: rgba(34, 197, 94, 0.18); color: #4ade80; }
[data-theme="dark"] .status-badge.warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
[data-theme="dark"] .status-badge.retired { background: rgba(100, 116, 139, 0.3); color: #cbd5e1; }


.profile-chip {
  border: 1px solid #bfdbfe;
  border-radius: 0.75rem;
  padding: 0.4rem 0.65rem;
  display: grid;
  background: rgba(255, 255, 255, 0.85);
  line-height: 1.2;
}
.profile-chip span { font-size: 0.75rem; color: #64748b; }
[data-theme='dark'] .profile-chip {
  border-color: rgba(96, 165, 250, 0.28);
  background: rgba(9, 18, 38, 0.82);
}

.trend-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: grid;
  gap: 0.55rem;
}
.trend-list li {
  border: 1px solid #bfdbfe;
  border-radius: 0.8rem;
  padding: 0.55rem;
  display: grid;
  gap: 0.2rem;
  background: rgba(239, 246, 255, 0.7);
}
[data-theme='dark'] .trend-list li {
  border-color: rgba(96, 165, 250, 0.28);
  background: rgba(15, 23, 42, 0.7);
}
.trend-list li span,
.trend-list li small { color: #64748b; font-size: 0.78rem; }

.ticket-summary {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 0.6rem;
  margin-bottom: 0.8rem;
}
.ticket-list {
  grid-column: 1 / -1;
  border: 1px solid #bfdbfe;
  border-radius: 0.8rem;
  padding: 0.55rem;
  display: grid;
  gap: 0.45rem;
}
.ticket-list div { display: grid; gap: 0.1rem; }
.ticket-list span { font-size: 0.75rem; color: #2563eb; font-weight: 700; }
.ticket-list small { color: #64748b; font-size: 0.75rem; }
[data-theme='dark'] .ticket-list { border-color: rgba(96, 165, 250, 0.28); }

.ticket-form { display: grid; gap: 0.55rem; margin-bottom: 0.75rem; }
.ticket-form label { display: grid; gap: 0.2rem; font-size: 0.82rem; }
.ticket-form input,
.ticket-form select,
.ticket-form textarea {
  border: 1px solid #bfdbfe;
  border-radius: 0.6rem;
  padding: 0.43rem;
  background: transparent;
  color: inherit;
}
.support-ways p { margin: 0.2rem 0; }
.support-ways ul { margin: 0.3rem 0 0 1.1rem; padding: 0; color: #64748b; }

@media (max-width: 1024px) {
  .ticket-summary { grid-template-columns: 1fr; }
}

.health-tile-grid {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 0.7rem;
}

.health-tile {
  border-radius: 0.9rem;
  border: 1px solid #bfdbfe;
  padding: 0.7rem;
  background: rgba(255, 255, 255, 0.92);
  display: grid;
  gap: 0.25rem;
}
.health-tile p { margin: 0; font-size: 0.72rem; text-transform: uppercase; color: #64748b; }
.health-tile h4 { margin: 0; font-size: 0.92rem; }
.health-tile span { font-weight: 700; text-transform: capitalize; }
.health-tile small { color: #64748b; font-size: 0.72rem; }

.health-tile.ok { border-color: rgba(34, 197, 94, 0.5); box-shadow: inset 0 0 0 1px rgba(34, 197, 94, 0.18); }
.health-tile.ok span { color: #16a34a; }
.health-tile.warn { border-color: rgba(245, 158, 11, 0.55); box-shadow: inset 0 0 0 1px rgba(245, 158, 11, 0.18); }
.health-tile.warn span { color: #d97706; }
.health-tile.down { border-color: rgba(239, 68, 68, 0.55); box-shadow: inset 0 0 0 1px rgba(239, 68, 68, 0.22); }
.health-tile.down span { color: #dc2626; }

[data-theme='dark'] .health-tile { background: rgba(9, 18, 38, 0.85); border-color: rgba(96, 165, 250, 0.28); }
[data-theme='dark'] .health-tile.ok span { color: #4ade80; }
[data-theme='dark'] .health-tile.warn span { color: #fbbf24; }
[data-theme='dark'] .health-tile.down span { color: #f87171; }

.support-ways a { color: #2563eb; font-weight: 600; text-decoration: none; }
[data-theme='dark'] .support-ways a { color: #93c5fd; }

@media (max-width: 1280px) {
  .health-tile-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
}

@media (max-width: 1024px) {
  .health-tile-grid { grid-template-columns: 1fr; }
}

:root {
  --bg-light: #eef3ff;
  --bg-dark: #0b1220;
  --surface-light: rgba(255, 255, 255, 0.92);
  --surface-dark: rgba(10, 17, 34, 0.9);
}

body { background: var(--bg-light); }
[data-theme='dark'] body { background: var(--bg-dark); }

.content {
  background: radial-gradient(circle at 10% 0%, rgba(37, 99, 235, 0.12), transparent 45%),
    radial-gradient(circle at 90% 100%, rgba(30, 64, 175, 0.08), transparent 38%);
}

.sidebar {
  background: linear-gradient(180deg, #0b1631, #071124);
  border-right: 1px solid rgba(59, 130, 246, 0.2);
}
[data-theme='light'] .sidebar {
  background: linear-gradient(180deg, #e8efff, #f4f8ff);
}

.panel,
.catalog-card,
.catalog-chip,
.health-tile,
.profile-chip {
  backdrop-filter: blur(6px);
}

.search-wrap {
  min-width: 320px;
}
.search-wrap input {
  width: 100%;
  border-radius: 0.7rem;
  border: 1px solid #bfdbfe;
  padding: 0.52rem 0.7rem;
  background: rgba(255, 255, 255, 0.9);
  color: inherit;
}
[data-theme='dark'] .search-wrap input {
  border-color: rgba(96, 165, 250, 0.35);
  background: rgba(12, 25, 50, 0.85);
  color: #dbeafe;
}


.ticketing-link { margin: 0.25rem 0 0; }
.ticketing-link a {
  color: #2563eb;
  font-weight: 700;
  text-decoration: none;
}
[data-theme='dark'] .ticketing-link a { color: #93c5fd; }

.btn.small {
  font-size: 0.72rem;
  padding: 0.28rem 0.5rem;
  border-radius: 0.5rem;
}

@media (max-width: 1200px) {
  .search-wrap { min-width: 220px; }
}

@media (max-width: 1024px) {
  .topbar-right { width: 100%; flex-wrap: wrap; }
  .search-wrap { min-width: 100%; }
}


.service-status-full {
  display: block;
}
.service-status-full .panel {
  width: 100%;
}

.catalog-card h4 {
  display: flex;
  align-items: center;
  gap: 0.45rem;
}
.catalog-icon {
  width: 1.4rem;
  height: 1.4rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 0.45rem;
  background: rgba(37, 99, 235, 0.14);
  font-size: 0.95rem;
}
[data-theme='dark'] .catalog-icon {
  background: rgba(59, 130, 246, 0.2);
}

.brand-block { display: flex; align-items: center; gap: 0.65rem; }
.logo-placeholder {
  width: 46px;
  height: 46px;
  border-radius: 0.8rem;
  border: 1px dashed rgba(147, 197, 253, 0.7);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 0.62rem;
  font-weight: 700;
  letter-spacing: 0.06em;
}

.theme-toggle {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  border: 1px solid rgba(100, 116, 139, 0.45);
  border-radius: 0.7rem;
  background: transparent;
  color: inherit;
  padding: 0.35rem 0.55rem;
  cursor: pointer;
}

.notification-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: grid;
  gap: 0.55rem;
}
.notification-list li {
  border: 1px solid #bfdbfe;
  border-radius: 0.75rem;
  padding: 0.55rem;
  display: grid;
  gap: 0.2rem;
  background: rgba(239, 246, 255, 0.72);
}
.notification-list small { color: #64748b; font-size: 0.72rem; }
.notification-list span { color: #334155; font-size: 0.8rem; }
[data-theme='dark'] .notification-list li {
  border-color: rgba(96, 165, 250, 0.28);
  background: rgba(15, 23, 42, 0.7);
}
[data-theme='dark'] .notification-list span { color: #cbd5e1; }

.approval-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: grid;
  gap: 0.45rem;
}
.approval-list li {
  border: 1px solid #bfdbfe;
  border-radius: 0.75rem;
  padding: 0.5rem;
  display: grid;
  gap: 0.14rem;
}
[data-theme='dark'] .approval-list li { border-color: rgba(96, 165, 250, 0.28); }
.approval-list small { color: #64748b; font-size: 0.75rem; }

.sort-btn {
  border: 0;
  background: transparent;
  color: inherit;
  cursor: pointer;
  font-weight: 700;
  font-size: 0.76rem;
  text-transform: lowercase;
}

.service-status-full { display: block; }
.service-status-full .panel { width: 100%; }

@media (max-width: 1024px) {
  .brand-block { align-items: flex-start; }
}


.panel-wide { width: 100%; }

.mini-card.rich {
  position: relative;
  overflow: hidden;
  background: linear-gradient(140deg, rgba(255,255,255,0.98), rgba(224, 236, 255, 0.9));
}
[data-theme='dark'] .mini-card.rich {
  background: linear-gradient(145deg, rgba(24, 39, 73, 0.95), rgba(14, 26, 50, 0.92));
}
.mini-icon {
  position: absolute;
  right: 0.65rem;
  top: 0.55rem;
  font-size: 1.05rem;
  opacity: 0.9;
}

.login-shell {
  min-height: 100vh;
  display: grid;
  grid-template-columns: 1.2fr 1fr;
  background: radial-gradient(circle at 20% 20%, rgba(37, 99, 235, 0.22), transparent 45%), #0b1220;
}
.login-hero {
  background-image:
    linear-gradient(135deg, rgba(3, 7, 18, 0.38), rgba(3, 7, 18, 0.28)),
    url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1800&q=80');
  background-size: cover;
  background-position: center;
  border-right: 1px solid rgba(96, 165, 250, 0.28);
}
.login-hero[data-login-theme='mountain'] {
  background-image:
    linear-gradient(135deg, rgba(2, 6, 23, 0.45), rgba(2, 6, 23, 0.30)),
    url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&w=1800&q=80');
}
.login-hero[data-login-theme='digital'] {
  background-image:
    linear-gradient(135deg, rgba(2, 6, 23, 0.55), rgba(2, 6, 23, 0.35)),
    url('https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=1800&q=80');
}
.login-panel {
  padding: 2.2rem;
  display: grid;
  align-content: center;
  gap: 0.85rem;
  color: #e2e8f0;
}
.login-panel h1 { margin: 0; font-size: 2rem; }
.login-panel p { margin: 0; color: #94a3b8; }
.login-panel .eyebrow { color: #93c5fd; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; }
.login-note { font-size: 0.8rem; }
.login-error { color: #fca5a5; min-height: 1.1rem; }

.login-help { margin-top: -0.25rem; }
.login-help a {
  color: #93c5fd;
  font-size: 0.85rem;
  text-decoration: none;
  font-weight: 600;
}
.login-help a:hover { text-decoration: underline; }

@media (max-width: 1024px) {
  .login-shell { grid-template-columns: 1fr; }
  .login-hero { min-height: 160px; }
}

    </style>
  </head>
  <body>
    <div id="root"></div>
    <script>
/**
 * ========================= IMPORTANT: MANAGEIQ API CONFIG =========================
 * Set your ManageIQ API base URL and endpoint paths below.
 * - baseUrl: Your ManageIQ host (example: https://miq.example.com)
 * - endpoints.*: ManageIQ REST API paths used by this portal
 * Authentication parameters are passed from login form to authenticateManageIQLocal().
 * That function sends credentials over HTTPS and stores only short-lived session token in sessionStorage.
 */
const MANAGEIQ_CONFIG = {
  baseUrl: 'https://manageiq.example.com', // <-- CHANGE THIS
  timeoutMs: 15000,
  endpoints: {
    auth: '/api/auth', // <-- CHANGE IF YOUR MIQ AUTH PATH DIFFERS
    rbacFeatures: '/api/authorization/features',
    serviceCatalogs: '/api/service_catalogs',
    serviceDialogs: '/api/service_dialogs',
    services: '/api/services',
    requests: '/api/requests',
    serviceOrders: '/api/service_orders',
    tags: '/api/tags'
  }
};

const SECURITY_CONFIG = {
  sessionTtlMs: 30 * 60 * 1000,
  requireHttps: true,
  strictRbac: false,
  // TESTING ONLY: allow ManageIQ over plain HTTP when your lab server has no TLS
  allowInsecureHttpForTesting: true,
  // Browser limitation: certificate validation cannot be bypassed from frontend JavaScript
  allowInvalidTlsForTesting: false
};

const SESSION_KEYS = {
  token: 'miq-auth-token',
  user: 'miq-auth-user',
  expiresAt: 'miq-auth-expires-at'
};

const state = {
  auth: {
    isAuthenticated: false,
    username: null,
    token: null,
    loginError: null,
    authSource: 'manageiq-local',
    permissions: new Set(),
    loginTheme: localStorage.getItem('login-theme') || 'ocean'
  },
  catalogs: [
    { id: 1, name: 'RHEL App Stack', description: 'Deploy hardened RHEL app stack', dialogId: 'vm-request', used: 32 },
    { id: 2, name: 'PostgreSQL HA', description: 'Provision DB with replication', dialogId: 'db-request', used: 21 },
    { id: 3, name: 'Kubernetes Namespace', description: 'Namespace with quotas and baseline policies', dialogId: 'k8s-request', used: 28 },
    { id: 4, name: 'Windows Build Agent', description: 'Provision build workers for enterprise CI', dialogId: 'vm-request', used: 15 }
  ],
  catalogIconPrefs: {
    'RHEL App Stack': 'üñ•Ô∏è',
    'PostgreSQL HA': 'üóÑÔ∏è',
    'Kubernetes Namespace': '‚ò∏Ô∏è',
    'Windows Build Agent': 'üõ†Ô∏è'
  },
  dialogs: {
    'vm-request': [
      { type: 'text', label: 'Application Name' },
      { type: 'select', label: 'Environment', options: ['Dev', 'Stage', 'Prod'] },
      { type: 'number', label: 'vCPU' },
      { type: 'textarea', label: 'Notes' }
    ],
    'db-request': [
      { type: 'text', label: 'DB Name' },
      { type: 'select', label: 'Engine', options: ['Postgres', 'MySQL', 'MSSQL'] }
    ],
    'k8s-request': [{ type: 'text', label: 'Namespace' }]
  },
  services: [
    { id: 201, name: 'payments-service', description: 'Payment orchestration and settlement microservice', lifecycle_state: 'provisioned', start_date: '2026-01-10', retirement_date: '2027-01-10', retirement_state: 'active' },
    { id: 202, name: 'etl-batch', description: 'Nightly ETL processing for finance analytics workloads', lifecycle_state: 'pending approval', start_date: '2026-02-20', retirement_date: '2026-05-01', retirement_state: 'about to retire' },
    { id: 203, name: 'audit-stream', description: 'Immutable audit event collector and retention pipeline', lifecycle_state: 'unprovisioned', start_date: '2025-01-16', retirement_date: '2026-01-30', retirement_state: 'retired' },
    { id: 204, name: 'sso-gateway', description: 'Identity federation and SSO policy enforcement gateway', lifecycle_state: 'provisioned', start_date: '2026-02-01', retirement_date: '2026-04-15', retirement_state: 'about to retire' }
  ],
  vmHealth: [
    { name: 'api-prod-01', type: 'VM', health: 'available', detail: 'CPU 41%, Memory 66%' },
    { name: 'etl-worker-02', type: 'VM', health: 'degraded', detail: 'High CPU contention' },
    { name: 'legacy-batch-01', type: 'VM', health: 'unavailable', detail: 'Host unreachable' }
  ],
  serviceRequests: [
    { sr: 'SR-1001', request_id: 'REQ-9031', service_order_id: 'SO-1101', requester: 'alex.morgan', request_status: 'finished', request_details: 'Provision payments service for prod namespace', approval_pending_with: null, requested_on: '2026-02-10' },
    { sr: 'SR-1002', request_id: 'REQ-9032', service_order_id: 'SO-1102', requester: 'alex.morgan', request_status: 'pending', request_details: 'Create ETL batch service for finance workloads', approval_pending_with: 'jane.approver', requested_on: '2026-02-11' },
    { sr: 'SR-1003', request_id: 'REQ-9033', service_order_id: 'SO-1103', requester: 'alex.morgan', request_status: 'queued', request_details: 'Deploy audit stream service with retention policy', approval_pending_with: null, requested_on: '2026-02-06' },
    { sr: 'SR-1004', request_id: 'REQ-9034', service_order_id: 'SO-1104', requester: 'alex.morgan', request_status: 'finished', request_details: 'Provision SSO gateway for edge identity', approval_pending_with: null, requested_on: '2026-02-09' }
  ],
  serviceOrders: [
    { id: 'SO-1101', service_id: 201, catalog_id: 1, ordered_on: '2026-02-10' },
    { id: 'SO-1102', service_id: 202, catalog_id: 2, ordered_on: '2026-02-11' },
    { id: 'SO-1103', service_id: 203, catalog_id: 3, ordered_on: '2026-02-06' },
    { id: 'SO-1104', service_id: 204, catalog_id: 4, ordered_on: '2026-02-09' }
  ],
  notifications: [
    { source: 'ServiceNow', message: 'CHG-1128 approved for payments-service patching.', timestamp: '2026-02-12T10:02:00Z' },
    { source: 'Jira Service Management', message: 'INC-20491 linked to etl-batch degradation.', timestamp: '2026-02-12T09:18:00Z' },
    { source: 'Remedy', message: 'REQ-9032 awaiting finance approver action.', timestamp: '2026-02-12T08:46:00Z' }
  ],
  supportTickets: [
    { id: 'SUP-7201', title: 'Need firewall egress rule', impacted_service: 'payments-service', status: 'In Progress', created_on: '2026-02-10' },
    { id: 'SUP-7190', title: 'Catalog order timeout', impacted_service: 'etl-batch', status: 'Resolved', created_on: '2026-02-04' }
  ],
  assets: [
    { sr: 'SR-2001', asset_name: 'vm-payments-01', created_date: '2026-01-10', retirement_date: '2027-01-10', status: 'active', service_id: 201, ip_address: '10.20.31.14', flavour: 'm6i.large', os: 'RHEL 9.3', tags: 'env:prod,team:payments' },
    { sr: 'SR-2002', asset_name: 'vm-etl-02', created_date: '2026-01-06', retirement_date: '2026-05-01', status: 'degraded', service_id: 202, ip_address: '10.20.44.27', flavour: 'm6i.xlarge', os: 'RHEL 8.9', tags: 'env:stage,team:data' },
    { sr: 'SR-2003', asset_name: 'vm-audit-03', created_date: '2025-01-16', retirement_date: '2026-01-30', status: 'retired', service_id: 203, ip_address: '10.20.51.90', flavour: 'm5.large', os: 'Ubuntu 22.04', tags: 'env:archive,team:security' }
  ],
  profile: { username: 'alex.morgan', name: 'Alex Morgan', email: 'alex.morgan@example.com', role: 'Platform Engineer', isApprover: true }
};

const root = document.getElementById('root');
const assetSort = { key: 'created_date', direction: 'desc' };

function htmlEscape(value) {
  return String(value)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function buildApiUrl(path) {
  return `${MANAGEIQ_CONFIG.baseUrl.replace(/\/$/, '')}${path}`;
}

function validateSecurityConfig() {
  const isHttps = MANAGEIQ_CONFIG.baseUrl.startsWith('https://');
  if (SECURITY_CONFIG.requireHttps && !SECURITY_CONFIG.allowInsecureHttpForTesting && !isHttps) {
    throw new Error('ManageIQ baseUrl must use HTTPS in production.');
  }
  if (!isHttps && SECURITY_CONFIG.allowInsecureHttpForTesting) {
    console.warn('Testing mode: allowing insecure HTTP ManageIQ endpoint. Do not use in production.');
  }
  if (SECURITY_CONFIG.allowInvalidTlsForTesting) {
    console.warn('Browser security model does not allow bypassing invalid TLS certificates from frontend code.');
  }
}

function clearAuthSession() {
  sessionStorage.removeItem(SESSION_KEYS.token);
  sessionStorage.removeItem(SESSION_KEYS.user);
  sessionStorage.removeItem(SESSION_KEYS.expiresAt);
}

/**
 * Generic authenticated ManageIQ API call helper.
 * Authentication parameter passing:
 * - Local login credentials are passed to authenticateManageIQLocal(username, password)
 * - After auth, token is stored in sessionStorage and passed as Bearer token here.
 */
async function manageIqFetch(path, { method = 'GET', body, username, password, token } = {}) {
  const headers = { Accept: 'application/json', 'Content-Type': 'application/json' };
  if (token) headers.Authorization = `Bearer ${token}`;
  if (!token && username && password) headers.Authorization = `Basic ${btoa(`${username}:${password}`)}`;

  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), MANAGEIQ_CONFIG.timeoutMs);
  try {
    const response = await fetch(buildApiUrl(path), {
      method,
      headers,
      body: body ? JSON.stringify(body) : undefined,
      signal: controller.signal,
      credentials: 'omit',
      mode: 'cors',
      redirect: 'error',
      cache: 'no-store',
      referrerPolicy: 'no-referrer'
    });
    if (!response.ok) throw new Error(`ManageIQ API error (${response.status})`);
    const contentType = response.headers.get('content-type') || '';
    if (!contentType.includes('application/json')) return {};
    return await response.json();
  } finally {
    clearTimeout(timeout);
  }
}

/**
 * Local authentication against ManageIQ.
 * Configure endpoint in MANAGEIQ_CONFIG.endpoints.auth.
 */
async function authenticateManageIQLocal(username, password) {
  const authPayload = await manageIqFetch(MANAGEIQ_CONFIG.endpoints.auth, {
    method: 'POST',
    body: { username, password },
    username,
    password
  });

  const token = authPayload.auth_token || authPayload.token;
  if (!token) {
    throw new Error('ManageIQ auth response did not include an auth token.');
  }

  const expiresAt = Date.now() + SECURITY_CONFIG.sessionTtlMs;
  sessionStorage.setItem(SESSION_KEYS.token, token);
  sessionStorage.setItem(SESSION_KEYS.user, username);
  sessionStorage.setItem(SESSION_KEYS.expiresAt, String(expiresAt));
  return token;
}

/**
 * RBAC feature pull from ManageIQ.
 * Configure endpoint in MANAGEIQ_CONFIG.endpoints.rbacFeatures.
 */
async function fetchManageIqRbac(token) {
  try {
    const payload = await manageIqFetch(MANAGEIQ_CONFIG.endpoints.rbacFeatures, { token });
    const featureList = payload.resources || payload.features || [];
    return new Set(featureList.map((item) => item.identifier || item.name || String(item)));
  } catch {
    return new Set();
  }
}

function hasPermission(permissionName) {
  if (!state.auth.permissions.size) return !SECURITY_CONFIG.strictRbac;
  return state.auth.permissions.has(permissionName);
}

function setTheme(next) {
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('portal-theme', next);
}

function renderLoginPage() {
  root.innerHTML = `
    <div class="login-shell">
      <div class="login-hero" data-login-theme="${htmlEscape(state.auth.loginTheme)}"></div>
      <div class="login-panel">
        <p class="eyebrow">Tata Consultancy Services</p>
        <h1>SovereignSecure Cloud</h1>
        <p>Cloud Management Portal ‚Äî Access TCS SSC Marketplace, Service Lifecycle, Requests and Support in one place.</p>
        <form id="loginForm" class="ticket-form">
          <label><span>Username</span><input id="loginUsername" type="text" autocomplete="username" required /></label>
          <label><span>Password</span><input id="loginPassword" type="password" autocomplete="current-password" required /></label>
          <label><span>Login Theme</span><select id="loginTheme">
            <option value="ocean">Ocean</option>
            <option value="mountain">Mountain</option>
            <option value="digital">Digital</option>
          </select></label>
          <button class="btn primary" type="submit">Sign In</button>
        </form>
        <p class="login-help"><a href="#" id="forgotPasswordLink">Forgot password?</a></p>
        <p class="login-note">Authentication source: ManageIQ local auth. Session token is stored in sessionStorage only.</p>
        <p id="loginError" class="login-error"></p>
      </div>
    </div>
  `;

  document.getElementById('forgotPasswordLink').addEventListener('click', (event) => {
    event.preventDefault();
    alert('Please use the ManageIQ password reset workflow or contact your Cloud Platform administrator.');
  });

  const loginThemeSelect = document.getElementById('loginTheme');
  loginThemeSelect.value = state.auth.loginTheme || 'ocean';
  loginThemeSelect.addEventListener('change', (event) => {
    const nextTheme = event.target.value;
    state.auth.loginTheme = nextTheme;
    localStorage.setItem('login-theme', nextTheme);
    const hero = document.querySelector('.login-hero');
    if (hero) hero.setAttribute('data-login-theme', nextTheme);
  });

  document.getElementById('loginForm').addEventListener('submit', async (event) => {
    event.preventDefault();
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const loginErrorEl = document.getElementById('loginError');
    loginErrorEl.textContent = '';

    try {
      const token = await authenticateManageIQLocal(username, password);
      state.auth.isAuthenticated = true;
      state.auth.username = username;
      state.auth.token = token;
      state.auth.permissions = await fetchManageIqRbac(token);
      renderAppShell();
    } catch (error) {
      state.auth.loginError = `Login failed: ${error.message}`;
      loginErrorEl.textContent = state.auth.loginError;
    }
  });
}

function serviceRetirementBadge(retirementState) {
  if (retirementState === 'active') return '<span class="status-badge active">‚óè active</span>';
  if (retirementState === 'about to retire') return '<span class="status-badge warning">‚óè about to retire</span>';
  return '<span class="status-badge retired">‚óè retired</span>';
}

function healthClass(status) {
  if (status === 'available') return 'ok';
  if (status === 'degraded') return 'warn';
  return 'down';
}

function renderOrderStatusRows() {
  return state.serviceRequests.map((request) => {
    const order = state.serviceOrders.find((serviceOrder) => serviceOrder.id === request.service_order_id) || {};
    const service = state.services.find((svc) => svc.id === order.service_id) || {};
    const catalog = state.catalogs.find((item) => item.id === order.catalog_id) || {};
    const lifecycleState = service.lifecycle_state || '-';
    return {
      sr: request.sr,
      request_id: request.request_id,
      order_id: order.id || '-',
      service_id: service.id || '-',
      service_name: service.name || '-',
      service_description: service.description || '-',
      request_status: request.request_status || '-',
      lifecycle_state: lifecycleState,
      approval_pending_with: lifecycleState === 'pending approval' ? request.approval_pending_with || '-' : '-',
      request_details: request.request_details || '-',
      catalog: catalog.name || '-',
      requested_on: request.requested_on || '-',
      start_date: service.start_date || '-',
      retirement_date: service.retirement_date || '-',
      retirement_state: service.retirement_state || 'retired'
    };
  });
}

function renderRequestStatusTable(rows) {
  return `
    <div class="panel compact">
      <h3>Request Status</h3>
      <div class="table-wrap"><table>
        <thead><tr><th>SR#</th><th>request_id</th><th>request_date</th><th>order_id</th><th>service_id</th><th>service_name</th><th>request_status</th><th>request_details</th><th>approval_pending_with</th><th>re-order</th></tr></thead>
        <tbody>
          ${rows
            .map(
              (row) => `<tr>
                <td>${htmlEscape(row.sr)}</td>
                <td>${htmlEscape(row.request_id)}</td>
                <td>${htmlEscape(row.requested_on)}</td>
                <td>${htmlEscape(row.order_id)}</td>
                <td>${htmlEscape(row.service_id)}</td>
                <td>${htmlEscape(row.service_name)}</td>
                <td>${htmlEscape(row.request_status)}</td>
                <td>${htmlEscape(row.request_details)}</td>
                <td>${htmlEscape(row.approval_pending_with)}</td>
                <td><button class="btn primary" data-reorder="${htmlEscape(row.catalog)}" ${hasPermission('service_order') ? '' : 'disabled'}>Re-order</button></td>
              </tr>`
            )
            .join('')}
        </tbody>
      </table></div>
    </div>`;
}

function renderServiceStatusTable(rows) {
  return `
    <div class="panel compact">
      <h3>Service Status</h3>
      <div class="table-wrap"><table>
        <thead><tr><th>SR#</th><th>request_id</th><th>order_id</th><th>service_id</th><th>service_name</th><th>service_description</th><th>lifecycle_state</th><th>start_date</th><th>retirement_date</th><th>retirement_status</th><th>actions</th></tr></thead>
        <tbody>
          ${rows
            .map(
              (row) => `<tr>
                <td>${htmlEscape(row.sr)}</td>
                <td>${htmlEscape(row.request_id)}</td>
                <td>${htmlEscape(row.order_id)}</td>
                <td>${htmlEscape(row.service_id)}</td>
                <td>${htmlEscape(row.service_name)}</td>
                <td>${htmlEscape(row.service_description)}</td>
                <td>${htmlEscape(row.lifecycle_state)}</td>
                <td>${htmlEscape(row.start_date)}</td>
                <td>${htmlEscape(row.retirement_date)}</td>
                <td>${serviceRetirementBadge(row.retirement_state)}</td>
                <td>
                  <button class="btn muted small" data-action="logs" data-service="${htmlEscape(row.service_name)}">Logs</button>
                  <button class="btn muted small" data-action="details" data-service="${htmlEscape(row.service_name)}">Details</button>
                </td>
              </tr>`
            )
            .join('')}
        </tbody>
      </table></div>
    </div>`;
}

async function updateServiceTags(serviceId, tags) {
  await manageIqFetch(MANAGEIQ_CONFIG.endpoints.tags, {
    method: 'POST',
    token: state.auth.token,
    body: { service_id: serviceId, tags }
  }).catch(() => null);
  const service = state.services.find((item) => item.id === serviceId);
  if (service) service.tags = tags;
  return { ok: true };
}

function renderAssetsTable() {
  const sorted = [...state.assets].sort((a, b) => {
    const av = a[assetSort.key];
    const bv = b[assetSort.key];
    if (av === bv) return 0;
    const cmp = String(av).localeCompare(String(bv), undefined, { numeric: true });
    return assetSort.direction === 'asc' ? cmp : -cmp;
  });

  const columns = ['sr', 'asset_name', 'created_date', 'retirement_date', 'status', 'service_id', 'ip_address', 'flavour', 'os', 'tags'];
  const headers = columns
    .map((col) => `<th><button class="sort-btn" data-sort="${col}">${col}${assetSort.key === col ? (assetSort.direction === 'asc' ? ' ‚Üë' : ' ‚Üì') : ''}</button></th>`)
    .join('');

  document.getElementById('assetsTablePanel').innerHTML = `
    <div class="table-wrap"><table>
      <thead><tr>${headers}<th>actions</th></tr></thead>
      <tbody>
        ${sorted
          .map(
            (asset) => `<tr>
              <td>${htmlEscape(asset.sr)}</td>
              <td>${htmlEscape(asset.asset_name)}</td>
              <td>${htmlEscape(asset.created_date)}</td>
              <td>${htmlEscape(asset.retirement_date)}</td>
              <td>${htmlEscape(asset.status)}</td>
              <td>${htmlEscape(asset.service_id)}</td>
              <td>${htmlEscape(asset.ip_address)}</td>
              <td>${htmlEscape(asset.flavour)}</td>
              <td>${htmlEscape(asset.os)}</td>
              <td>${htmlEscape(asset.tags)}</td>
              <td><button class="btn muted small" data-edit-tags="${htmlEscape(asset.service_id)}">Edit Tags</button></td>
            </tr>`
          )
          .join('')}
      </tbody>
    </table></div>`;
}

function renderAppShell() {
  root.innerHTML = `
    <div class="app-shell">
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-head">
          <div class="brand-block">
            <div class="logo-placeholder">LOGO</div>
            <div><p>Tata Consultancy Services</p><h2>SovereignSecure Cloud</h2></div>
          </div>
          <button class="btn muted mobile-only" id="closeSidebar">‚úï</button>
        </div>
        <nav>
          <button class="nav-item active" data-section="dashboard">dashboard</button>
          <button class="nav-item" data-section="request-status">request status</button>
          <button class="nav-item" data-section="your-services">your services</button>
          <button class="nav-item" data-section="your-assets">your assets</button>
          <button class="nav-item" data-section="marketplace">TCS SSC marketplace</button>
        </nav>
      </aside>
      <main class="content">
        <header class="topbar">
          <div class="topbar-left">
            <button class="btn muted mobile-only" id="openSidebar">‚ò∞</button>
            <div><h1>Cloud Management Portal</h1><p>Access TCS SSC Marketplace, Service Lifecycle, Requests and Support in one place</p></div>
          </div>
          <div class="topbar-right">
            <div class="search-wrap">
              <input id="globalSearch" type="search" placeholder="Search request id, service id, marketplace item" />
            </div>
            <button class="theme-toggle" id="toggleTheme" title="Switch day/night"><span>‚òÄÔ∏è</span><span>üåô</span></button>
            <button class="btn muted" id="logoutBtn">Sign Out</button>
            <div class="profile-chip"><strong>${htmlEscape(state.profile.name)}</strong><span>${htmlEscape(state.auth.username || state.profile.role)}</span></div>
          </div>
        </header>

        <section data-view="dashboard" class="view-stack">
          <div class="card-strip" id="dashboardMetrics"></div>
          <div class="panel panel-wide">
            <div class="panel-head"><h3>Notifications</h3></div>
            <div id="notificationPanel"></div>
          </div>
          <div class="grid two-col">
            <div class="panel">
              <div class="panel-head"><h3>Trending Requests (Last 7 Days)</h3></div>
              <div id="trendingRequests"></div>
            </div>
            <div class="panel">
              <div class="panel-head"><h3>Support Tickets</h3></div>
              <div id="ticketSummary" class="ticket-summary"></div>
              <form id="ticketForm" class="ticket-form">
                <label><span>Raise a ticket</span><input id="ticketTitle" type="text" placeholder="Brief issue summary" required /></label>
                <label><span>Impacted Service</span><select id="ticketService" required></select></label>
                <label><span>Description</span><textarea id="ticketDetails" placeholder="What do you need help with?" required></textarea></label>
                <button class="btn primary" type="submit">Submit Ticket</button>
              </form>
              <p class="ticketing-link"><a href="https://support.example.com" target="_blank" rel="noopener noreferrer">Open Ticketing Tool</a></p>
            </div>
          </div>
        </section>

        <section data-view="request-status" style="display:none" class="view-stack">
          <div class="panel compact">
            <h3>Request Status Data Sources</h3>
            <p>/api/requests ¬∑ /api/service_orders ¬∑ /api/services</p>
          </div>
          <div class="panel" id="requestTablePanel"></div>
        </section>

        <section data-view="your-services" style="display:none" class="view-stack">
          <div class="panel compact">
            <h3>Service Health Data Source</h3>
            <p>/api/services</p>
          </div>
          <div class="service-status-full" id="serviceHealthTables"></div>
          <div class="card-strip" id="healthMetrics"></div>
          <div class="health-tile-grid" id="healthTiles"></div>
        </section>

        <section data-view="your-assets" style="display:none" class="view-stack">
          <div class="panel compact">
            <h3>Your Assets</h3>
            <p>Sorted by creation date by default. Click column headers to sort by any field.</p>
          </div>
          <div class="panel" id="assetsTablePanel"></div>
        </section>

        <section data-view="marketplace" style="display:none" class="view-stack">
          <div class="panel">
            <div class="panel-head"><h3>TCS SSC Marketplace</h3></div>
            <div class="catalog-grid" id="catalogGrid"></div>
          </div>
          <div class="panel" id="dialogPanel" style="display:none"></div>
        </section>
      </main>
    </div>
  `;

  setTheme(localStorage.getItem('portal-theme') || 'dark');
  document.getElementById('toggleTheme').addEventListener('click', () => {
    const cur = document.documentElement.getAttribute('data-theme');
    setTheme(cur === 'dark' ? 'light' : 'dark');
  });

  document.getElementById('logoutBtn').addEventListener('click', () => {
    clearAuthSession();
    state.auth = { isAuthenticated: false, username: null, token: null, loginError: null, authSource: 'manageiq-local', permissions: new Set(), loginTheme: localStorage.getItem('login-theme') || 'ocean' };
    renderLoginPage();
  });

  const orderedServiceStatus = renderOrderStatusRows();

  const dashboardCards = [
    ['üü¢', 'Active Services', orderedServiceStatus.filter((row) => row.retirement_state === 'active').length, 'Operational services'],
    ['üü°', 'Expiring Services (‚â§ 3 months)', orderedServiceStatus.filter((row) => row.retirement_state === 'about to retire').length, 'Needs renewal planning'],
    ['‚ö´', 'Retired Services', orderedServiceStatus.filter((row) => row.retirement_state === 'retired').length, 'Already retired'],
    ['üé´', 'My Support Tickets', state.supportTickets.length, 'Open and resolved tickets']
  ];

  document.getElementById('dashboardMetrics').innerHTML = dashboardCards
    .map(([icon, label, value, hint]) => `<article class="mini-card rich"><span class="mini-icon">${icon}</span><p>${label}</p><h4>${value}</h4><small>${hint}</small></article>`)
    .join('');

  document.getElementById('notificationPanel').innerHTML = `<ul class="notification-list">${state.notifications
    .map((item) => `<li><strong>${htmlEscape(item.source)}</strong><small>${new Date(item.timestamp).toLocaleString()}</small><span>${htmlEscape(item.message)}</span></li>`)
    .join('')}</ul>`;

  const trendingRequests = [...orderedServiceStatus]
    .filter((row) => {
      const requested = new Date(row.requested_on);
      const now = new Date('2026-02-12');
      return (now - requested) / (1000 * 60 * 60 * 24) <= 7;
    })
    .sort((a, b) => b.requested_on.localeCompare(a.requested_on));

  document.getElementById('trendingRequests').innerHTML = trendingRequests.length === 0
    ? '<p>No trending requests in the last 7 days.</p>'
    : `<ul class="trend-list">${trendingRequests.map((item) => `<li><strong>${htmlEscape(item.service_name)}</strong><span>${htmlEscape(item.requested_on)}</span><small>${htmlEscape(item.request_status)} ¬∑ ${htmlEscape(item.request_details)}</small></li>`).join('')}</ul>`;

  function renderTicketSummary() {
    const openCount = state.supportTickets.filter((ticket) => ticket.status !== 'Resolved').length;
    document.getElementById('ticketSummary').innerHTML = `
      <article class="mini-card"><p>Open Tickets</p><h4>${openCount}</h4><small>Needs action</small></article>
      <article class="mini-card"><p>Resolved Tickets</p><h4>${state.supportTickets.length - openCount}</h4><small>Closed successfully</small></article>
      <div class="ticket-list">${state.supportTickets
        .map((ticket) => `<div><strong>${htmlEscape(ticket.id)}</strong><span>${htmlEscape(ticket.status)}</span><small>${htmlEscape(ticket.title)} ¬∑ Impacted: ${htmlEscape(ticket.impacted_service)}</small></div>`)
        .join('')}</div>
    `;
  }

  renderTicketSummary();

  document.getElementById('ticketService').innerHTML = state.services.map((service) => `<option value="${htmlEscape(service.name)}">${htmlEscape(service.id)} ¬∑ ${htmlEscape(service.name)}</option>`).join('');

  document.getElementById('ticketForm').addEventListener('submit', (event) => {
    event.preventDefault();
    const title = document.getElementById('ticketTitle').value.trim();
    const details = document.getElementById('ticketDetails').value.trim();
    const impactedService = document.getElementById('ticketService').value;
    if (!title || !details || !impactedService) return;
    const newId = `SUP-${7202 + state.supportTickets.length}`;
    state.supportTickets.unshift({ id: newId, title: `${title} (${details})`, impacted_service: impactedService, status: 'New', created_on: '2026-02-12' });
    renderTicketSummary();
    event.target.reset();
  });

  document.getElementById('requestTablePanel').innerHTML = renderRequestStatusTable(orderedServiceStatus);
  document.getElementById('serviceHealthTables').innerHTML = renderServiceStatusTable(orderedServiceStatus);

  document.getElementById('healthMetrics').innerHTML = [
    ['Provisioned', orderedServiceStatus.filter((row) => row.lifecycle_state === 'provisioned').length, 'Running ordered services'],
    ['Pending Approval', orderedServiceStatus.filter((row) => row.lifecycle_state === 'pending approval').length, 'Approval workflow in progress'],
    ['Unprovisioned', orderedServiceStatus.filter((row) => row.lifecycle_state === 'unprovisioned').length, 'Not yet provisioned'],
    ['About to Retire', orderedServiceStatus.filter((row) => row.retirement_state === 'about to retire').length, 'Needs renewal decision']
  ]
    .map(([label, value, hint]) => `<article class="mini-card"><p>${label}</p><h4>${value}</h4><small>${hint}</small></article>`)
    .join('');

  document.getElementById('healthTiles').innerHTML = [
    ...state.vmHealth,
    ...orderedServiceStatus.map((service) => ({
      name: service.service_name,
      type: 'Service',
      health: service.lifecycle_state === 'provisioned' ? 'available' : service.lifecycle_state === 'pending approval' ? 'degraded' : 'unavailable',
      detail: `${service.lifecycle_state} ¬∑ starts ${service.start_date}`
    }))
  ]
    .map((item) => `<article class="health-tile ${healthClass(item.health)}"><p>${item.type}</p><h4>${htmlEscape(item.name)}</h4><span>${item.health}</span><small>${htmlEscape(item.detail)}</small></article>`)
    .join('');

  function bindCatalogOrderButtons() {
    document.querySelectorAll('[data-order]').forEach((button) => {
      button.addEventListener('click', () => {
        const id = Number(button.dataset.order);
        const catalog = state.catalogs.find((c) => c.id === id);
        const fields = state.dialogs[catalog?.dialogId] || state.dialogs['vm-request'] || [];
        const panel = document.getElementById('dialogPanel');
        panel.style.display = 'block';
        panel.innerHTML = `
          <div class="panel-head"><h3>${htmlEscape(catalog?.name || 'Catalog')} - Service Dialog</h3></div>
          <div class="dialog-grid">
            ${fields
              .map((field) => {
                if (field.type === 'select') return `<label><span>${htmlEscape(field.label)}</span><select>${field.options.map((o) => `<option>${htmlEscape(o)}</option>`).join('')}</select></label>`;
                if (field.type === 'textarea') return `<label><span>${htmlEscape(field.label)}</span><textarea></textarea></label>`;
                return `<label><span>${htmlEscape(field.label)}</span><input type="${htmlEscape(field.type)}" /></label>`;
              })
              .join('')}
          </div>
          <div style="margin-top:.75rem"><button class="btn primary">Submit Request</button></div>
        `;
        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });
  }

  const catalogIcons = {
    'RHEL App Stack': 'üñ•Ô∏è',
    'PostgreSQL HA': 'üóÑÔ∏è',
    'Kubernetes Namespace': '‚ò∏Ô∏è',
    'Windows Build Agent': 'üõ†Ô∏è'
  };

  function renderCatalogGrid() {
    document.getElementById('catalogGrid').innerHTML = state.catalogs
      .map(
        (catalog) => `<article class="catalog-card"><h4><span class="catalog-icon">${catalogIcons[catalog.name] || 'üì¶'}</span>${htmlEscape(catalog.name)}</h4><p>${htmlEscape(catalog.description)}</p><div class="catalog-footer"><span>Template</span><button class="btn primary" data-order="${htmlEscape(catalog.id)}" ${hasPermission('service_order') ? '' : 'disabled'}>Order Service</button></div></article>`
      )
      .join('');
    bindCatalogOrderButtons();
  }

  renderCatalogGrid();
  renderAssetsTable();

  document.addEventListener('click', async (event) => {
    const target = event.target;
    if (target.matches('[data-reorder]')) {
      const catalogName = target.dataset.reorder;
      const catalog = state.catalogs.find((item) => item.name === catalogName);
      if (!catalog) return;
      showSection('marketplace');
      document.querySelector(`[data-order="${catalog.id}"]`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    if (target.matches('[data-action]')) {
      const action = target.dataset.action;
      const serviceName = target.dataset.service;
      alert(action === 'logs' ? `Opening logs for ${serviceName}` : `Opening service details for ${serviceName}`);
    }
    if (target.matches('[data-sort]')) {
      const key = target.dataset.sort;
      if (assetSort.key === key) {
        assetSort.direction = assetSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        assetSort.key = key;
        assetSort.direction = 'asc';
      }
      renderAssetsTable();
    }
    if (target.matches('[data-edit-tags]')) {
      const serviceId = Number(target.dataset.editTags);
      const asset = state.assets.find((item) => item.service_id === serviceId);
      const nextTags = prompt('Enter comma-separated tags', asset?.tags || '');
      if (nextTags === null) return;
      const response = await updateServiceTags(serviceId, nextTags);
      if (response.ok && asset) {
        asset.tags = nextTags;
        renderAssetsTable();
        alert(`Tags updated for service ${serviceId}`);
      }
    }
  });

  document.getElementById('globalSearch').addEventListener('input', () => {
    const input = document.getElementById('globalSearch').value.trim().toLowerCase();
    if (!input) return;
    const hasMatch = orderedServiceStatus.some((row) => row.request_id.toLowerCase().includes(input) || String(row.service_id).includes(input)) || state.catalogs.some((catalog) => catalog.name.toLowerCase().includes(input));
    if (!hasMatch) alert('No matching request/service/catalog found.');
  });

  function showSection(section) {
    document.querySelectorAll('.nav-item').forEach((b) => b.classList.toggle('active', b.dataset.section === section));
    document.querySelectorAll('[data-view]').forEach((view) => {
      view.style.display = view.dataset.view === section ? 'block' : 'none';
    });
    document.getElementById('sidebar').classList.remove('open');
  }

  document.getElementById('openSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.add('open'));
  document.getElementById('closeSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.remove('open'));
  document.querySelectorAll('.nav-item').forEach((btn) => btn.addEventListener('click', () => showSection(btn.dataset.section)));
}

function bootstrap() {
  try {
    validateSecurityConfig();
  } catch (error) {
    root.innerHTML = `<div class="panel" style="margin:1rem">${htmlEscape(error.message)}</div>`;
    return;
  }

  const existingToken = sessionStorage.getItem(SESSION_KEYS.token);
  const existingUser = sessionStorage.getItem(SESSION_KEYS.user);
  const expiresAt = Number(sessionStorage.getItem(SESSION_KEYS.expiresAt) || 0);
  const isExpired = !expiresAt || Date.now() > expiresAt;

  if (existingToken && existingUser && !isExpired) {
    state.auth.isAuthenticated = true;
    state.auth.username = existingUser;
    state.auth.token = existingToken;
    renderAppShell();
  } else {
    clearAuthSession();
    renderLoginPage();
  }
}

setTheme(localStorage.getItem('portal-theme') || 'dark');
bootstrap();

</script>
  </body>
</html>
